generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Instance {
  id           String   @id @default(cuid())
  name         String
  brandName    String?
  sheetId      String?
  sheetGid     String?
  destinations String[]
  plan         Plan     @default(BASIC)
  activo       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users        User[]
  products     Product[]
  labels       Label[]
  bitacora     BitacoraEntry[]
  printPresets PrintPreset[]
}

model User {
  id             String    @id @default(cuid())
  firebaseUid    String    @unique
  email          String    @unique
  name           String
  role           Role      @default(VIEWER)
  status         Status    @default(ACTIVE)
  licenseEndDate DateTime?

  // Dynamic permissions array (module + sub-action codes)
  permisos String[] @default([])
  activo   Boolean  @default(true)

  // Nullable instanceId: null = super-admin (global access)
  instanceId String?
  instance   Instance? @relation(fields: [instanceId], references: [id])
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([firebaseUid])
  @@index([instanceId])
}

enum Role {
  ADMIN
  EDITOR
  VIEWER
}

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Plan {
  BASIC
  ENTERPRISE
}

model Product {
  id               String  @id @default(cuid())
  code             String
  batchAbbr        String?
  name             String
  category         String?
  sede             String?
  ingredients      String?
  allergens        String?
  storage          String?
  usage            String?
  packaging        String?

  refrigeratedDays Int @default(0)
  frozenDays       Int @default(0)
  ambientDays      Int @default(0)

  calories         Float?
  energyKj         Float?
  fat              Float?
  saturatedFat     Float?
  carbs            Float?
  sugars           Float?
  fiber            Float?
  protein          Float?
  sodium           Float?

  servingSize          Float?
  servingsPerContainer Float?

  instanceId String
  instance   Instance @relation(fields: [instanceId], references: [id])
  labels     Label[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([code, instanceId])
  @@index([instanceId])
}

model Label {
  id             String    @id @default(cuid())
  productName    String
  brand          String?
  netContent     String?
  origin         String?
  productionDate DateTime?
  batch          String?
  expiry         String?
  packedBy       String?
  destination    String?
  qrData         String?

  productId  String?
  product    Product?  @relation(fields: [productId], references: [id])
  instanceId String
  instance   Instance  @relation(fields: [instanceId], references: [id])
  createdAt  DateTime  @default(now())

  @@index([instanceId])
}

model BitacoraEntry {
  id                 String    @id @default(cuid())
  category           String?
  productName        String
  coldChain          String?
  processDate        DateTime?
  expiryRefrigerated DateTime?
  expiryFrozen       DateTime?
  quantity           String?
  quantityProduced   String?
  packedBy           String?
  destination        String?
  batch              String?
  traceDate          DateTime?

  instanceId String
  instance   Instance @relation(fields: [instanceId], references: [id])
  createdAt  DateTime @default(now())

  @@index([instanceId])
  @@index([createdAt])
}

model PrintPreset {
  id           String @id @default(cuid())
  name         String
  widthMm      Float
  heightMm     Float
  marginTop    Float  @default(0)
  marginRight  Float  @default(0)
  marginBottom Float  @default(0)
  marginLeft   Float  @default(0)
  orientation  String @default("portrait")
  stockType    String?

  instanceId String
  instance   Instance @relation(fields: [instanceId], references: [id])

  @@index([instanceId])
}
